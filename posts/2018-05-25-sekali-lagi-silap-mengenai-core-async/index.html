<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>blog burhanloey: Sekali lagi silap mengenai core.async</title>
    <link rel="canonical" href="https://www.burhanloey.com/blog/posts/2018-05-25-sekali-lagi-silap-mengenai-core-async/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Alegreya|PT+Serif">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css">
    <link href="/blog/css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog/">blog burhanloey</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/blog/">Home</a></li>
                <li
                ><a href="/blog/archives/">Archives</a></li>
                
                <li
                >
                <a href="/blog/about/">About</a>
                </li>
                
                <li><a href="/blog/feed.xml">RSS</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-9">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">May 25, 2018</div>
        
    </div>
    <h2>Sekali lagi silap mengenai core.async</h2>
</div>
<div>
    
    <p>Sekali lagi saya salah mengenai core.async dalam post saya yang lepas.</p><blockquote><p> Secara ringkasnya cara yang betul ialah yang mula-mula di mana saya  menggunakan transducer. Cara yang salah ialah yang di mana saya menggunakan  pub sub (yang saya sangkakan betul). </p></blockquote><p>Semalam saya tidak berpuas hati dengan code untuk pub sub, sebab perlu tulis terlalu panjang. Takkanlah perlu tulis code seperti itu walaupun untuk buat benda yang remeh. Saya pun baca-bacalah mengenai core.async, async vs. sync, dan motivasi di sebalik setiap paradigm.</p><p>Bila sebut tentang concurrency, masalahnya bukan mengenai bagaimana untuk menjalankan code secara parallel (serentak), tetapi mengenai bagaimana untuk menyatukan kembali data-data yang telah dihantar ke thread-thread yang berlainan.</p><p>Antara teknik yang selalu kita dengar apabila sebut tentang asynchronous ialah callback atau event-driven. Jadi ada paradigm seperti future/promise untuk mengelakkan callback hell. Paradigm untuk core.async adalah seperti BlockingQueue. Saya pun baca mengenai rationale di sebalik design core.async.</p><p>Yang saya faham, tujuan core.async adalah supaya kita boleh menulis code seperti synchronous tetapi di sebalik tabir, code akan berjalan secara asynchronous. Contohnya, apabila kita menggunakan take (<code>&lt;!</code>) dalam block go, dalam kepala kita, kita rasakan seperti itu operasi blocking, tetapi di sebalik tabir, program menulis callback untuk sambung semula proses apabila channel tersebut dah ready.</p><p>Untuk meyakinkan diri saya, saya tulis code yang sama untuk server Netty iaitu http-kit untuk bandingkan dengan server Jetty yang saya guna sebelum ini. Kalau load testing menunjukkan request per second untuk Netty lebih tinggi daripada Jetty bermakna saya betul, kalau sama bermakna code saya salah.</p><p>Hasilnya,</p><pre><code class="text">Code transducer untuk Jetty: 3500+ req/s
Code transducer untuk Netty: 8000+ req/s
Code pub/sub untuk Jetty: 2000+ req/s
Code pub/sub untuk Netty: 2000+ req/s
</code></pre><p>Apa yang berlaku dalam code pub/sub ialah semua request perlu melalui satu channel sahaja. Saya dengan tidak sengaja telah mengubah multithreaded server menjadi single-threaded, asynchronous server. Aduh.</p><p>Dari segi masa response, page untuk code pub/sub load lebih laju, tetapi setiap kali saya request page, req/s jatuh ke 1500+. Untuk code transducer, masa untuk load page dalam 1-2 saat, tetapi req/s tak jatuh-jatuh.</p><p>Sekarang dah yakin bahawa code transducer adalah yang betul. Cuma ada sedikit kekurangan. Dalam code tersebut, saya terlupa untuk tutup channel selepas menghantar response. Selepas sedikit refactor, code jadi begini:</p><pre><code class="clojure">&#40;defn- validate-form &#91;&#91;response-chan form&#93;&#93;
  &#40;let &#91;form-chan &#40;chan&#41;&#93;
    &#40;go
      &#40;let &#91;&#91;errors &#95;&#93; &#40;v/validate-registration form&#41;
            valid? &#40;not errors&#41;&#93;
        &#40;if valid?
          &#40;&gt;! form-chan form&#41;
          &#40;do
            &#40;close! form-chan&#41;
            &#40;&gt;! response-chan &#40;-&gt; &#40;redirect &quot;/daftar&quot;&#41;
                                  &#40;flash {:errors errors :data form}&#41;&#41;&#41;&#41;&#41;&#41;&#41;
    &#91;response-chan form-chan&#93;&#41;&#41;

&#40;defn- check-existing-user &#91;&#91;response-chan form-chan&#93;&#93;
  &#40;let &#91;user-chan &#40;chan&#41;&#93;
    &#40;go
      &#40;if-let &#91;form &#40;&lt;! form-chan&#41;&#93;
        &#40;let &#91;username-existed &#40;thread &#40;users/find-user-by-username db-spec form&#41;&#41;
              email-existed &#40;thread &#40;users/find-user-by-email db-spec form&#41;&#41;
              available? &#40;not &#40;or &#40;&lt;! username-existed&#41;
                                  &#40;&lt;! email-existed&#41;&#41;&#41;&#93;
          &#40;if available?
            &#40;&gt;! user-chan form&#41;
            &#40;do
              &#40;close! user-chan&#41;
              &#40;&gt;! response-chan &#40;-&gt; &#40;redirect &quot;/daftar&quot;&#41;
                                    &#40;flash {:message &#40;:user-existed msg&#41;}&#41;&#41;&#41;&#41;&#41;&#41;
        &#40;close! user-chan&#41;&#41;&#41;
    &#91;response-chan user-chan&#93;&#41;&#41;

&#40;defn- persist-user &#91;&#91;response-chan user-chan&#93;&#93;
  &#40;go
    &#40;when-let &#91;user &#40;&lt;! user-chan&#41;&#93;
      &#40;let &#91;email-verification-token &#40;codecs/bytes-&gt;hex &#40;nonce/random-bytes 16&#41;&#41;
            prepared-user &#40;-&gt; user
                              &#40;update :password hashers/derive&#41;
                              &#40;assoc :token email-verification-token&#41;&#41;
            success? &#40;-&gt;&gt; &#40;thread &#40;users/register-user db-spec prepared-user&#41;&#41;
                          &lt;!
                          pos?&#41;&#93;
        &#40;if success?
          &#40;do
            &#40;future &#40;mailer/send-email-verification user&#41;&#41;
            &#40;&gt;! response-chan &#40;-&gt; &#40;redirect &quot;/login&quot;&#41;
                                  &#40;flash {:message &#40;:success msg&#41;}&#41;&#41;&#41;&#41;
          &#40;&gt;! response-chan &#40;-&gt; &#40;redirect &quot;/daftar&quot;&#41;
                                &#40;flash {:message &#40;:failed msg&#41;}&#41;&#41;&#41;&#41;&#41;&#41;&#41;&#41;

&#40;defn register-handler &#91;{:keys &#91;params&#93; :as req} respond &#95;&#93;
  &#40;let &#91;response-chan &#40;chan&#41;
        form &#40;select-keys params &#91;:username :email :password&#93;&#41;&#93;
    &#40;go
      &#40;-&gt;&gt; &#91;response-chan form&#93;
           validate-form
           check-existing-user
           persist-user&#41;&#41;
    &#40;go
      &#40;respond &#40;&lt;! response-chan&#41;&#41;
      &#40;close! response-chan&#41;&#41;&#41;&#41;
</code></pre><p>Code yang terbaharu ini lain sedikit daripada yang transducer sebab dulu saya kurang faham tujuan block go. Penggunaan transducer sama sahaja dengan thread-last macro <code>-&gt;&gt;</code> yang saya gunakan di sini.</p><p>Kalau saya tidak tutup channel, takut lama-lama server akan ada software rot.</p><p>Dengan code yang baru ini, server Jetty mampu capai 4200+ req/s. Mungkin sebab kurang channel ataupun sebab saya tutup channel.</p><p>Apa-apa pun sekarang saya sangat berpuas hati sebab boleh buat server (http-kit) sama performance dengan Play Framework, framework yang saya guna di tempat kerja yang lepas.</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/blog/tags/clojure/">clojure</a>
    
    <a href="/blog/tags/concurrency/">concurrency</a>
    
    <a href="/blog/tags/lisp/">lisp</a>
    
</div>


    <div id="prev-next">
        
        <a href="/blog/posts/2018-05-26-penggunaan-high-level-api-core-async/">&laquo; Penggunaan high level API core.async</a>
        
        
        <a class="right" href="/blog/posts/2018-05-23-pembetulan-post-lepas-mengenai-core-async/">Pembetulan post lepas mengenai core.async &raquo;</a>
        
    </div>

    


</div>

            </div>
        </div>

        <div class="col-md-3">
            <div id="sidebar">
                
                
                <div id="recent">
                    <h3>Recent Posts</h3>
                    <ul>
                        
                        <li><a href="/blog/posts/2018-05-26-penggunaan-high-level-api-core-async/">Penggunaan high level API core.async</a></li>
                        
                        <li><a href="/blog/posts/2018-05-25-sekali-lagi-silap-mengenai-core-async/">Sekali lagi silap mengenai core.async</a></li>
                        
                        <li><a href="/blog/posts/2018-05-23-pembetulan-post-lepas-mengenai-core-async/">Pembetulan post lepas mengenai core.async</a></li>
                        
                    </ul>
                </div>
                
                
                <div id="tags">
                    <h3>Tags</h3>
                    <ul>
                        
                        <li><a href="/blog/tags/clojure/">clojure</a></li>
                        
                        <li><a href="/blog/tags/concurrency/">concurrency</a></li>
                        
                        <li><a href="/blog/tags/lisp/">lisp</a></li>
                        
                        <li><a href="/blog/tags/java/">java</a></li>
                        
                        <li><a href="/blog/tags/completablefuture/">completablefuture</a></li>
                        
                        <li><a href="/blog/tags/web-scraping/">web-scraping</a></li>
                        
                        <li><a href="/blog/tags/c++/">c++</a></li>
                        
                        <li><a href="/blog/tags/go/">go</a></li>
                        
                        <li><a href="/blog/tags/javascript/">javascript</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2018 Burhanuddin Baharuddin
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/blog/js/highlight.pack.js" type="text/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
