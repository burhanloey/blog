<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>blog burhanloey: Penggunaan high level API core.async</title>
    <link rel="canonical" href="https://www.burhanloey.com/blog/posts/2018-05-26-penggunaan-high-level-api-core-async/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Alegreya|PT+Serif">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css">
    <link href="/blog/css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog/">blog burhanloey</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/blog/">Home</a></li>
                <li
                ><a href="/blog/archives/">Archives</a></li>
                
                <li
                >
                <a href="/blog/about/">About</a>
                </li>
                
                <li><a href="/blog/feed.xml">RSS</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-9">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">May 26, 2018</div>
        
    </div>
    <h2>Penggunaan high level API core.async</h2>
</div>
<div>
    
    <p><img src="/blog/images/bruce_core_async.png" alt="Tweet dari Bruce Hauman" /></p><p>Semalam saya nampak Bruce Hauman ada <a href='https://twitter.com/bhauman/status/1000070247863365632'>tweet</a> mengenai core.async. Macam tau-tau je saya pun tengah mula nak guna. Saya pun tengok video yang beliau tweet, <a href='https://www.youtube.com/watch?v=096pIlA3GDo'>video</a> dari Timothy Baldridge yang menunjukkan bagaimana cara menggunakan core.async dalam situasi sebenar. Beliau pun perasan ramai yang buat silap termasuklah saya.</p><p>Dalam video tersebut, Timothy Baldridge sangat menggalakkan penggunaan function <code>pipeline</code>. Sebelum ini saya masih tak faham waktu bila yang sesuai untuk menggunakan function tersebut. Saya pun tengoklah <a href='https://clojure.github.io/core.async/'>documentation</a> core.async.</p><p>Dalam documentation tersebut, ada banyak lagi function yang bunyinya lebih kurang sama macam function untuk functional programming, antaranya map, reduce, merge, dan split. Saya pun go through documentation untuk semua function tersebut perlahan-lahan.</p><p>Semasa membaca documentation, saya perasan ada persamaan antara function-function tersebut, iaitu ayat yang berbunyi lebih kurang seperti ini:</p><blockquote><p> The channels will close after the source channel has closed. </p></blockquote><p>Maksudnya kalau kita hanya menggunakan function-function high level tersebut untuk compose, sebaik sahaja kita <code>close!</code> channel input, automatik channel-channel lain akan ditutup.</p><p>Berbeza dengan yang sebelum ini di mana saya terpaksa <code>close!</code> channel satu per satu, dan secara jujurnya saya ada terlepas pandang untuk tutup beberapa channel.</p><p>Jadi, selepas refactor, code saya jadi begini:</p><pre><code class="clojure">&#40;defn- check-existing-user &#91;&#91;&#95; form&#93; out-ch&#93;
  &#40;-&gt;&gt; &#91;&#40;async/thread &#40;users/find-user-by-username db-spec form&#41;&#41;
        &#40;async/thread &#40;users/find-user-by-email db-spec form&#41;&#41;&#93;
       &#40;async/merge&#41;
       &#40;async/reduce #&#40;boolean &#40;or %1 %2&#41;&#41; false&#41;
       &#40;async/pipeline 1 out-ch &#40;map #&#40;vector % form&#41;&#41;&#41;&#41;&#41;

&#40;defn- generate-token &#91;&#93;
  &#40;codecs/bytes-&gt;hex &#40;nonce/random-bytes 16&#41;&#41;&#41;

&#40;defn- persist-user &#91;&#91;&#95; user&#93; out-ch&#93;
  &#40;let &#91;prepared-user &#40;-&gt; user
                          &#40;update :password hashers/derive&#41;
                          &#40;assoc :token &#40;generate-token&#41;&#41;&#41;&#93;
    &#40;-&gt;&gt; &#40;async/thread &#40;users/register-user db-spec prepared-user&#41;&#41;
         &#40;async/pipeline 1 out-ch &#40;map #&#40;vector &#40;zero? %&#41; user&#41;&#41;&#41;&#41;&#41;&#41;

&#40;defn- split-if-error &#91;ch&#93;
  &#40;async/split first ch&#41;&#41;

&#40;defn register-handler &#91;{:keys &#91;params&#93; :as req} respond &#95;&#93;
  &#40;let &#91;input-ch &#40;chan 1 &#40;map v/validate-registration&#41;&#41;
        &#91;invalid-ch valid-ch&#93; &#40;split-if-error input-ch&#41;

        availability-ch &#40;chan&#41;
        &#91;not-available-ch available-ch&#93; &#40;split-if-error availability-ch&#41;

        persisting-ch &#40;chan&#41;
        &#91;failed-ch success-ch&#93; &#40;split-if-error persisting-ch&#41;&#93;

    &#40;-&gt;&gt; valid-ch
         &#40;async/pipeline-async 1 availability-ch check-existing-user&#41;&#41;
    &#40;-&gt;&gt; available-ch
         &#40;async/pipeline-async 1 persisting-ch persist-user&#41;&#41;

    &#40;go
      &#40;let &#91;&#91;val ch&#93; &#40;alts! &#91;invalid-ch not-available-ch failed-ch success-ch&#93;&#41;
            response &#40;condp = ch
                       invalid-ch
                       &#40;-&gt; &#40;redirect &quot;/daftar&quot;&#41;
                           &#40;flash {:errors &#40;first val&#41; :data &#40;second val&#41;}&#41;&#41;

                       not-available-ch
                       &#40;-&gt; &#40;redirect &quot;/daftar&quot;&#41;
                           &#40;flash {:message &#40;:user-existed msg&#41;}&#41;&#41;

                       failed-ch
                       &#40;-&gt; &#40;redirect &quot;/daftar&quot;&#41;
                           &#40;flash {:message &#40;:failed msg&#41;}&#41;&#41;

                       success-ch
                       &#40;do
                         &#40;future &#40;mailer/send-email-verification &#40;second val&#41;&#41;&#41;
                         &#40;-&gt; &#40;redirect &quot;/login&quot;&#41;
                             &#40;flash {:message &#40;:success msg&#41;}&#41;&#41;&#41;&#41;&#93;
        &#40;respond response&#41;
        &#40;close! input-ch&#41;&#41;&#41;

    &#40;put! input-ch params&#41;&#41;&#41;
</code></pre><p>Jika diperhatikan, saya hanya menggunakan satu block go sahaja. Tiada langsung take (<code>&lt;!</code>) atau put (<code>&gt;!</code>). Saya juga hanya perlu <code>close!</code> satu channel sahaja selepas selesai menghantar response. Error handling juga saya bawa sehingga ke bahagian akhir sekali, jadi tiada <em>side-effect</em>.</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/blog/tags/clojure/">clojure</a>
    
    <a href="/blog/tags/concurrency/">concurrency</a>
    
    <a href="/blog/tags/lisp/">lisp</a>
    
</div>


    <div id="prev-next">
        
        
        <a class="right" href="/blog/posts/2018-05-25-sekali-lagi-silap-mengenai-core-async/">Sekali lagi silap mengenai core.async &raquo;</a>
        
    </div>

    


</div>

            </div>
        </div>

        <div class="col-md-3">
            <div id="sidebar">
                
                
                <div id="recent">
                    <h3>Recent Posts</h3>
                    <ul>
                        
                        <li><a href="/blog/posts/2018-05-26-penggunaan-high-level-api-core-async/">Penggunaan high level API core.async</a></li>
                        
                        <li><a href="/blog/posts/2018-05-25-sekali-lagi-silap-mengenai-core-async/">Sekali lagi silap mengenai core.async</a></li>
                        
                        <li><a href="/blog/posts/2018-05-23-pembetulan-post-lepas-mengenai-core-async/">Pembetulan post lepas mengenai core.async</a></li>
                        
                    </ul>
                </div>
                
                
                <div id="tags">
                    <h3>Tags</h3>
                    <ul>
                        
                        <li><a href="/blog/tags/clojure/">clojure</a></li>
                        
                        <li><a href="/blog/tags/concurrency/">concurrency</a></li>
                        
                        <li><a href="/blog/tags/lisp/">lisp</a></li>
                        
                        <li><a href="/blog/tags/java/">java</a></li>
                        
                        <li><a href="/blog/tags/completablefuture/">completablefuture</a></li>
                        
                        <li><a href="/blog/tags/web-scraping/">web-scraping</a></li>
                        
                        <li><a href="/blog/tags/c++/">c++</a></li>
                        
                        <li><a href="/blog/tags/go/">go</a></li>
                        
                        <li><a href="/blog/tags/javascript/">javascript</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2018 Burhanuddin Baharuddin
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/blog/js/highlight.pack.js" type="text/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
