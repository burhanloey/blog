<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>blog burhanloey</title>
    <link rel="canonical" href="https://www.burhanloey.com/blog/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Alegreya|PT+Serif">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css">
    <link href="css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog/">blog burhanloey</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li  class="active" ><a href="/blog/">Home</a></li>
                <li
                ><a href="/blog/archives/">Archives</a></li>
                
                <li
                >
                <a href="/blog/about/">About</a>
                </li>
                
                <li><a href="/blog/feed.xml">RSS</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-9">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">May 21, 2018</div>
        
    </div>
    <h2>Refactor code core.async menggunakan Transducer</h2>
</div>
<div>
    
     <p>Dulu saya hanya menulis code Clojure secara <em>synchronous</em>, dan hanya pindahkan code ke <em>thread</em> lain bila perlu. Baru-baru ini saya jenguk-jenguk code untuk <a href='https://github.com/ring-clojure/ring'>Ring</a>, dan saya mula perasan setiap <em>middleware</em> mengambil dua jenis function, satu function 1-<em>arity</em> yang biasa, satu lagi function 3-<em>arity</em>. Saya pun tertanya-tanya apa guna function 3-<em>arity</em> ni.</p><p>Lepas check, rupa-rupanya function 3-<em>arity</em> itu adalah untuk <em>async handler</em>. Server Clojure yang lain memang dah boleh handle <em>async request</em>, contohnya <a href='https://github.com/ztellman/aleph'>Aleph</a> dan <a href='https://github.com/http-kit/http-kit'>http-kit</a>, tapi saya tak suka guna sebab tak ikut standard Ring. Server default untuk Ring ialah Jetty. Versi Jetty yang latest dah ikut spec Servlet 3.1, jadi dah boleh handle <em>async request</em>.</p><p>Jadi, untuk enable function 3-<em>arity</em>, kalau menggunakan <a href='https://github.com/weavejester/lein-ring'>lein-ring</a>, cuma perlu set option <code>:async?</code> ke <code>true</code>. Kemudian tukar handler dari,</p><pre><code class="clojure">&#40;defn hello-handler &#91;req&#93;
  {:status 200
   :headers {}
   :body &quot;Hello&quot;}&#41;
</code></pre><p>ke</p><pre><code class="clojure">&#40;defn hello-handler &#91;req respond raise&#93;
  &#40;respond {:status 200
            :headers {}
            :body &quot;Hello&quot;}&#41;&#41;
</code></pre><p>Maksudnya kalau kita panggil function <code>respond</code> dari mana-mana thread pun, dia akan terus bagi response. Tak perlu guna blocking call dah.</p><p>Maka saya pun cubalah menulis handler menggunakan <a href='https://github.com/clojure/core.async'>core.async</a>. Konsep <code>core.async</code> sama sahaja dengan konsep concurrency dalam programming language Go.</p><p>Ini cubaan pertama:</p><pre><code class="clojure">&#40;defn register &#91;{:keys &#91;params&#93;} respond &#95;&#93;
  &#40;let &#91;form &#40;select-keys params &#91;:username :email :password&#93;&#41;
        validated &#40;chan&#41;
        user &#40;chan&#41;
        new-user &#40;chan&#41;
        hashed &#40;chan&#41;
        result &#40;chan&#41;&#93;
    &#40;go &#40;&gt;! validated &#40;v/validate-registration form&#41;&#41;&#41;
    &#40;go &#40;let &#91;&#91;errors data&#93; &#40;&lt;! validated&#41;&#93;
          &#40;if errors
            &#40;&gt;! result &#40;-&gt; &#40;redirect &quot;/daftar&quot;&#41;
                           &#40;flash {:errors errors
                                   :data data}&#41;&#41;&#41; ; assoc previous data
            &#40;&gt;! user data&#41;&#41;&#41;&#41;
    &#40;go &#40;let &#91;u           &#40;&lt;! user&#41;
              by-username &#40;async/thread &#40;find-user-by-username &#40;:username u&#41;&#41;&#41;
              by-email    &#40;async/thread &#40;find-user-by-email &#40;:email u&#41;&#41;&#41;&#93;
          &#40;if &#40;or &#40;&lt;! by-username&#41; &#40;&lt;! by-email&#41;&#41;
            &#40;&gt;! result &#40;-&gt; &#40;redirect &quot;/daftar&quot;&#41;
                           &#40;flash {:message &quot;Username/email sudah diambil. Sila daftar menggunakan username/email yang lain.&quot;}&#41;&#41;&#41;
            &#40;&gt;! new-user u&#41;&#41;&#41;&#41;
    &#40;go &#40;&gt;! hashed &#40;update &#40;&lt;! new-user&#41; :password hashers/derive&#41;&#41;&#41;
    &#40;go &#40;&lt;! hashed&#41;
        &#40;&gt;! result &#40;-&gt; &#40;redirect &quot;/login&quot;&#41;
                       &#40;flash &quot;Anda sudah berjaya mendaftar. Sila log masuk .&quot;&#41;&#41;&#41;&#41;
    &#40;go &#40;let &#91;&#91;res &#95;&#93; &#40;alts! &#91;result &#40;timeout 10000&#41;&#93;&#41;&#93;
          &#40;respond res&#41;&#41;&#41;&#41;&#41;
</code></pre><p>Ambik kau. Buruk nak mampus. Jalan memang jalan code-nya, logic semua ok, tapi dah takde rupa functional programming.</p><p>Jadi, saya tengok balik <a href='https://clojuredocs.org/clojure.core.async/chan'>documentation</a> untuk <code>chan</code>, saya perasan ada parameter <code>xform</code>. Eh?!</p><p>Saya tahu guna core.async, saya tahu guna transducer, tapi saya baru tahu boleh guna core.async dengan transducer sama-sama.</p><p>Selepas refactor, code jadi begini:</p><pre><code class="clojure">&#40;def user-existed-msg &quot;Username/email sudah diambil. Sila daftar menggunakan username/email yang lain.&quot;&#41;
&#40;def success-msg &quot;Anda sudah berjaya mendaftar. Sila log masuk .&quot;&#41;

&#40;defn- make-flash-msg &#91;&#91;errors data&#93;&#93;
  &#40;if errors
    &#91;{:errors errors :data data} data&#93;
    &#91;nil data&#93;&#41;&#41;

&#40;defn- hash-user-password &#91;&#91;errors user :as all&#93;&#93;
  &#40;if errors
    all
    &#91;errors &#40;update user :password hashers/derive&#41;&#93;&#41;&#41;

&#40;defn- make-response &#91;&#91;errors &#95;&#93;&#93;
  &#40;if errors
    &#40;-&gt; &#40;redirect &quot;/daftar&quot;&#41;
        &#40;flash errors&#41;&#41;
    &#40;-&gt; &#40;redirect &quot;/login&quot;&#41;
        &#40;flash success-msg&#41;&#41;&#41;&#41;

&#40;def validate-xform
  &#40;comp
   &#40;map v/validate-registration&#41;
   &#40;map make-flash-msg&#41;&#41;&#41;

&#40;def register-xform
  &#40;comp
   &#40;map hash-user-password&#41;
   ;; TODO: Add one more function here in the middle to persist user
   &#40;map make-response&#41;&#41;&#41;

&#40;defn register &#91;{:keys &#91;params&#93;} respond &#95;&#93;
  &#40;let &#91;validated &#40;chan 1 validate-xform&#41;
        result &#40;chan 1 register-xform&#41;&#93;
    &#40;go &#40;&gt;! validated &#40;select-keys params &#91;:username :email :password&#93;&#41;&#41;&#41;
    &#40;go &#40;let &#91;&#91;errors user :as all&#93; &#40;&lt;! validated&#41;&#93;
          &#40;cond
            ;; If already has errors, skip checking for existing user.
            errors &#40;&gt;! result all&#41;
            ;; Check for existing user with same username or email.
            &#40;or &#40;&lt;! &#40;async/thread &#40;find-user-by-username &#40;:username user&#41;&#41;&#41;&#41;
                &#40;&lt;! &#40;async/thread &#40;find-user-by-email &#40;:email user&#41;&#41;&#41;&#41;&#41;
            &#40;&gt;! result &#91;{:message user-existed-msg} user&#93;&#41;
            ;; Return same data if there is no problem.
            :else &#40;&gt;! result all&#41;&#41;&#41;&#41;
    &#40;go &#40;let &#91;&#91;res &#95;&#93; &#40;alts! &#91;result &#40;timeout 10000&#41;&#93;&#41;&#93;
          &#40;respond res&#41;&#41;&#41;&#41;&#41;
</code></pre><p>Sekarang barulah pendek-pendek function tersebut.</p><p>Beza dengan yang asal ialah yang asal saya terus bagi result sebaik sahaja ada error. Orang panggil <em>short circuit</em>. Masalah dengan cara tersebut ialah cara tersebut merupakan <em>side-effect</em>. <em>Side-effect</em> sangat tidak digalakkan dalam functional programming.</p><p>Jadi, saya tukar kepada menggunakan konsep monad. Saya jadikan function-function untuk <code>xform</code> supaya return sebuah vector di mana item pertama ialah error dan item kedua ialah data sebenar yang perlu return. Error tersebut akan diselesaikan di pengakhiran iaitu dalam function <code>make-response</code>.</p><p>Gambar ini mungkin lebih jelas:</p><p><img src="/blog/images/monad.png" alt="Gambar menunjukkan konsep monad" /></p><p>Masalah yang tinggal sekarang ialah panggilan ke <code>async/thread</code> untuk <code>find-user-by-username</code> dan <code>find-user-by-email</code>. Masalahnya sebab saya tidak boleh panggil <code>&lt;!</code> di luar block <code>go</code>. Kalau boleh, bolehlah saya letak bahagian tersebut sebagai xform.</p><p>Jadi, tengoklah dulu.</p><p>Edit: Ini code selepas saya guna <a href='https://clojuredocs.org/clojure.core/eduction'>eduction</a>. Taktahu lah sama ada ini dikira best practice. Function <code>register</code> jadi lagi pendek kira ok lah tu.</p><pre><code class="clojure">&#40;def user-existed-msg &quot;Username/email sudah diambil. Sila daftar menggunakan username/email yang lain.&quot;&#41;
&#40;def success-msg &quot;Anda sudah berjaya mendaftar. Sila log masuk .&quot;&#41;

&#40;defn- make-flash-msg &#91;&#91;errors data&#93;&#93;
  &#40;if errors
    &#91;{:errors errors :data data} data&#93;
    &#91;nil data&#93;&#41;&#41;

&#40;def validate-xform
  &#40;comp
   &#40;map v/validate-registration&#41;
   &#40;map make-flash-msg&#41;&#41;&#41;

&#40;defn- validate &#91;form&#93;
  &#40;let &#91;validated &#40;chan 1 validate-xform&#41;&#93;
    &#40;put! validated form&#41;
    validated&#41;&#41;

&#40;defn- find-existing-user &#91;validated&#93;
  &#40;go &#40;let &#91;&#91;errors user :as all&#93; &#40;&lt;! validated&#41;
            already-existed &#40;chan&#41;&#93;
        &#40;if errors
          &#40;put! already-existed false&#41;
          &#40;let &#91;by-username &#40;async/thread &#40;find-user-by-username &#40;:username user&#41;&#41;&#41;
                by-email &#40;async/thread &#40;find-user-by-email &#40;:email user&#41;&#41;&#41;&#93;
            &#40;put! already-existed &#40;boolean &#40;or &#40;&lt;! by-username&#41; &#40;&lt;! by-email&#41;&#41;&#41;&#41;&#41;&#41;
        &#40;conj all already-existed&#41;&#41;&#41;&#41;

&#40;defn- check-existing-user &#91;user-check&#93;
  &#40;go &#40;let &#91;&#91;errors user already-existed :as all&#93; &#40;&lt;! user-check&#41;&#93;
        &#40;cond
          errors all
          &#40;&lt;! already-existed&#41; &#91;{:message user-existed-msg} user&#93;
          :else all&#41;&#41;&#41;&#41;          

&#40;defn- hash-user-password &#91;new-user&#93;
  &#40;go &#40;let &#91;&#91;errors user :as all&#93; &#40;&lt;! new-user&#41;&#93;
        &#40;if errors
          all
          &#91;errors &#40;async/thread &#40;update user :password hashers/derive&#41;&#41;&#93;&#41;&#41;&#41;&#41;

&#40;defn- persist-user &#91;new-user&#93;
  &#40;go &#40;let &#91;&#91;errors hashed-user :as all&#93; &#40;&lt;! new-user&#41;&#93;
        &#40;if errors
          all
          &#40;do
            &#40;println &quot;Registered: &quot; &#40;&lt;! hashed-user&#41;&#41;
            all&#41;&#41;&#41;&#41;&#41;

&#40;defn- make-response &#91;registered&#93;
  &#40;go &#40;let &#91;&#91;errors &#95;&#93; &#40;&lt;! registered&#41;&#93;
        &#40;if errors
          &#40;-&gt; &#40;redirect &quot;/daftar&quot;&#41;
              &#40;flash errors&#41;&#41;
          &#40;-&gt; &#40;redirect &quot;/login&quot;&#41;
              &#40;flash success-msg&#41;&#41;&#41;&#41;&#41;&#41;

&#40;def register-xform
  &#40;comp
   &#40;map validate&#41;
   &#40;map find-existing-user&#41;
   &#40;map check-existing-user&#41;
   &#40;map hash-user-password&#41;
   &#40;map persist-user&#41;
   &#40;map make-response&#41;&#41;&#41;

&#40;defn register &#91;{:keys &#91;params&#93;} respond &#95;&#93;
  &#40;let &#91;form &#40;select-keys params &#91;:username :email :password&#93;&#41;
        &#91;response&#93; &#40;eduction register-xform &#91;form&#93;&#41;&#93;
    &#40;go &#40;let &#91;&#91;res &#95;&#93; &#40;alts! &#91;response &#40;timeout 10000&#41;&#93;&#41;&#93;
          &#40;respond res&#41;&#41;&#41;&#41;&#41;
</code></pre>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/blog/tags/clojure/">clojure</a>
    
    <a href="/blog/tags/concurrency/">concurrency</a>
    
    <a href="/blog/tags/lisp/">lisp</a>
    
</div>


    

    <div id="prev-next">
        
        
        <a class="right" href="/blog/posts/2017-05-06-greenspun-tenth-rule/">Greenspun&#39;s Tenth Rule &raquo;</a>
        
    </div>
</div>

            </div>
        </div>

        <div class="col-md-3">
            <div id="sidebar">
                
                
                <div id="recent">
                    <h3>Recent Posts</h3>
                    <ul>
                        
                        <li><a href="/blog/posts/2018-05-21-refactor-core-async-menggunakan-transducer/">Refactor code core.async menggunakan Transducer</a></li>
                        
                        <li><a href="/blog/posts/2017-05-06-greenspun-tenth-rule/">Greenspun&#39;s Tenth Rule</a></li>
                        
                        <li><a href="/blog/posts/2017-02-18-concurrency-model-dalam-clojure/">Concurrency Model dalam Clojure</a></li>
                        
                    </ul>
                </div>
                
                
                <div id="tags">
                    <h3>Tags</h3>
                    <ul>
                        
                        <li><a href="/blog/tags/clojure/">clojure</a></li>
                        
                        <li><a href="/blog/tags/concurrency/">concurrency</a></li>
                        
                        <li><a href="/blog/tags/lisp/">lisp</a></li>
                        
                        <li><a href="/blog/tags/java/">java</a></li>
                        
                        <li><a href="/blog/tags/completablefuture/">completablefuture</a></li>
                        
                        <li><a href="/blog/tags/web-scraping/">web-scraping</a></li>
                        
                        <li><a href="/blog/tags/c++/">c++</a></li>
                        
                        <li><a href="/blog/tags/go/">go</a></li>
                        
                        <li><a href="/blog/tags/javascript/">javascript</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2018 Burhanuddin Baharuddin
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="js/highlight.pack.js" type="text/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
