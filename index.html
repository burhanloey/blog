<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>blog burhanloey</title>
    <link rel="canonical" href="https://www.burhanloey.com/blog/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Alegreya|PT+Serif">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css">
    <link href="css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog/">blog burhanloey</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li  class="active" ><a href="/blog/">Home</a></li>
                <li
                ><a href="/blog/archives/">Archives</a></li>
                
                <li
                >
                <a href="/blog/about/">About</a>
                </li>
                
                <li><a href="/blog/feed.xml">RSS</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-9">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">May 23, 2018</div>
        
    </div>
    <h2>Pembetulan post lepas mengenai core.async</h2>
</div>
<div>
    
    <p>Post yang <a href='/blog/posts/2018-05-21-refactor-core-async-menggunakan-transducer/'>lepas</a> ada kesilapan yang sangat kritikal. Cara penggunaan transducer dengan core.async tidak salah. Yang salahnya ialah saya create semua <code>chan</code> yang untuk process untuk setiap request. Maksudnya tak ada beza sama ada saya tulis secara synchronous ataupun asynchronous.</p><blockquote><p> Load testing yang menunjukkan server Java mampu untuk handle request walaupun  banyak silap yang saya buat menunjukkan betapa hebatnya Java Virtual Machine. </p></blockquote><p>Semalam saya tengok <a href='http://www.youtube.com/watch?v=enwIIGzhahw'>talk</a> dari Timothy Baldridge mengenai core.async. Yang membuatkan saya sedar yang saya silap apabila beliau bercakap mengenai <a href='https://clojuredocs.org/clojure.core.async/mult'>mult</a>. Function <code>mult</code> itulah yang saya tercari-cari.</p><p>Satu lagi yang saya terlepas pandang ialah <a href='https://clojuredocs.org/clojure.core.async/go-loop'>go-loop</a>. Clojure menyediakan <code>go-loop</code> hanya untuk membuatkan loop di dalam block go. Maksudnya cara tersebut selalu diguna pakai sehingga mereka memerlukan macro untuk proses tersebut. Saya selalu dengar mengenai <code>event loop</code> setiap kali berbincang mengenai asynchronous. Jadi, <code>go-loop</code> tersebut samalah seperti <code>event loop</code> untuk dispatch dari channel ke channel.</p><p>Maka saya pun tulis semula code tersebut menggunakan <code>go-loop</code> dan <code>mult</code>. Hasilnya,</p><pre><code class="clojure">&#40;def register-response-chan &#40;chan&#41;&#41;


&#40;def validate-chan &#40;chan 1 &#40;map v/validate-registration&#41;&#41;&#41;

&#40;def valid-form-chan &#40;chan&#41;&#41;
&#40;def valid-form-mult &#40;mult valid-form-chan&#41;&#41;

&#40;go-loop &#91;&#93;
  &#40;let &#91;&#91;errors form&#93; &#40;&lt;! validate-chan&#41;&#93;
    &#40;if errors
      &#40;&gt;! register-response-chan &#40;-&gt; &#40;redirect &quot;/daftar&quot;&#41;
                                     &#40;flash {:errors errors :data form}&#41;&#41;&#41;
      &#40;&gt;! valid-form-chan form&#41;&#41;
    &#40;recur&#41;&#41;&#41;


&#40;def username-existed-chan &#40;chan&#41;&#41;
&#40;def email-existed-chan &#40;chan&#41;&#41;
&#40;def user-existed-chan &#40;chan&#41;&#41;

&#40;let &#91;c &#40;chan 1&#41;&#93;
  &#40;tap valid-form-mult c&#41;
  &#40;async/thread
    &#40;loop &#91;&#93;
      &#40;let &#91;user &#40;&lt;!! c&#41;&#93;
        &#40;&gt;!! username-existed-chan
             &#40;boolean &#40;users/find-user-by-username db-spec user&#41;&#41;&#41;
        &#40;recur&#41;&#41;&#41;&#41;&#41;

&#40;let &#91;c &#40;chan&#41;&#93;
  &#40;tap valid-form-mult c&#41;
  &#40;async/thread
    &#40;loop &#91;&#93;
      &#40;let &#91;user &#40;&lt;!! c&#41;&#93;
        &#40;&gt;!! email-existed-chan
             &#40;boolean &#40;users/find-user-by-email db-spec user&#41;&#41;&#41;
        &#40;recur&#41;&#41;&#41;&#41;&#41;

&#40;go-loop &#91;&#93;
  &#40;let &#91;username-existed &#40;&lt;! username-existed-chan&#41;
        email-existed &#40;&lt;! email-existed-chan&#41;&#93;
    &#40;&gt;! user-existed-chan &#40;or username-existed email-existed&#41;&#41;
    &#40;recur&#41;&#41;&#41;


&#40;def register-chan &#40;chan&#41;&#41;
&#40;def register-mult &#40;mult register-chan&#41;&#41;

&#40;let &#91;c &#40;chan&#41;&#93;
  &#40;tap valid-form-mult c&#41;
  &#40;go-loop &#91;&#93;
    &#40;let &#91;user-existed &#40;&lt;! user-existed-chan&#41;&#93;
      &#40;if user-existed
        &#40;&gt;! register-response-chan &#40;-&gt; &#40;redirect &quot;/daftar&quot;&#41;
                                       &#40;flash {:message user-existed-msg}&#41;&#41;&#41;
        &#40;&gt;! register-chan &#40;&lt;! c&#41;&#41;&#41;
      &#40;recur&#41;&#41;&#41;&#41;


&#40;def hashed-password-chan &#40;chan&#41;&#41;
&#40;def email-verification-token-chan &#40;chan&#41;&#41;
&#40;def prepared-user-chan &#40;chan&#41;&#41;

&#40;let &#91;c &#40;chan&#41;&#93;
  &#40;tap register-mult c&#41;
  &#40;async/thread
    &#40;loop &#91;&#93;
      &#40;let &#91;{:keys &#91;password&#93;} &#40;&lt;!! c&#41;&#93;
        &#40;&gt;!! hashed-password-chan &#40;hashers/derive password&#41;&#41;
        &#40;recur&#41;&#41;&#41;&#41;&#41;

&#40;let &#91;c &#40;chan&#41;&#93;
  &#40;tap register-mult c&#41;
  &#40;go-loop &#91;&#93;
    &#40;&lt;! c&#41;
    &#40;&gt;! email-verification-token-chan &#40;-&gt; &#40;nonce/random-bytes 16&#41;
                                          &#40;codecs/bytes-&gt;hex&#41;&#41;&#41;
    &#40;recur&#41;&#41;&#41;

&#40;let &#91;c &#40;chan&#41;&#93;
  &#40;tap register-mult c&#41;
  &#40;go-loop &#91;&#93;
    &#40;let &#91;user &#40;&lt;! c&#41;
          password &#40;&lt;! hashed-password-chan&#41;
          token &#40;&lt;! email-verification-token-chan&#41;&#93;
      &#40;&gt;! prepared-user-chan &#40;assoc user :password password :token token&#41;&#41;
      &#40;recur&#41;&#41;&#41;&#41;


&#40;def persisted-user-chan &#40;chan&#41;&#41;
&#40;def persisted-user-mult &#40;mult persisted-user-chan&#41;&#41;

&#40;async/thread
  &#40;loop &#91;&#93;
    &#40;let &#91;user &#40;&lt;!! prepared-user-chan&#41;
          row-count &#40;users/register-user db-spec user&#41;&#93;
      &#40;if &#40;zero? row-count&#41;
        &#40;&gt;!! register-response-chan &#40;-&gt; &#40;redirect &quot;/daftar&quot;&#41;
                                        &#40;flash {:message failed-msg}&#41;&#41;&#41;
        &#40;&gt;!! persisted-user-chan user&#41;&#41;
      &#40;recur&#41;&#41;&#41;&#41;

&#40;let &#91;c &#40;chan&#41;&#93;
  &#40;tap persisted-user-mult c&#41;
  &#40;async/thread
    &#40;loop &#91;&#93;
      &#40;let &#91;user &#40;&lt;!! c&#41;&#93;
        &#40;mailer/send-email-verification user&#41;
        &#40;recur&#41;&#41;&#41;&#41;&#41;

&#40;let &#91;c &#40;chan&#41;&#93;
  &#40;tap persisted-user-mult c&#41;
  &#40;go-loop &#91;&#93;
    &#40;&lt;! c&#41;
    &#40;&gt;! register-response-chan &#40;-&gt; &#40;redirect &quot;/login&quot;&#41;
                                   &#40;flash success-msg&#41;&#41;&#41;
    &#40;recur&#41;&#41;&#41;

&#40;defn register &#91;{:keys &#91;params&#93;} respond &#95;&#93;
  &#40;let &#91;form &#40;select-keys params &#91;:username :email :password&#93;&#41;&#93;
    &#40;put! validate-chan form&#41;
    &#40;go &#40;let &#91;&#91;res &#95;&#93; &#40;alts! &#91;register-response-chan &#40;timeout 10000&#41;&#93;&#41;&#93;
          &#40;respond res&#41;&#41;&#41;&#41;&#41;
</code></pre><p>Tengok function untuk handler yang bawah sekali boleh nampak dia takde create channel atau thread yang baru, tugas dia hanya masukkan data ke channel yang mula-mula iaitu <code>validate-chan</code> kemudian tunggu response dari <code>register-response-chan</code>.</p><p>Kalau sesiapa yang mula dengar pasal <code>go loop</code> mungkin akan ingat, "Eh, takpe ke buat banyak-banyak loop? Tak makan CPU ke nanti?". Jawapannya, sebab block go ialah sebuah macro. Apabila kita buat panggilan <code>&gt;!</code> atau <code>&lt;!</code> dia bukannya block, tetapi parking. Kalau tengok code untuk macro go, di dalamnya ada macam state machine. Senang cerita jangan risau pasal performance.</p><p>Jadi, tengok balik code yang baru di atas, kalau sekali pandang macam nak muntah. Berterabur saya letak channel. Waktu saya menulis code tersebut, saya rasa macam saya sedang menulis code pub/sub atau reactive programming. Saya pun google 'core.async pub/sub'. Lahaii, memang ada. <a href='https://github.com/clojure/core.async/wiki/Pub-Sub'>Pub/sub</a> merupakan cara yang lebih high level untuk menggantikan penggunaan <code>mult</code>.</p><p>Selepas refactor, code jadi begini:</p><pre><code class="clojure">&#40;def pub-chan &#40;chan&#41;&#41;
&#40;def publication &#40;pub pub-chan :msg-type&#41;&#41;

&#40;def response-chan &#40;chan&#41;&#41;
&#40;sub publication :response response-chan&#41;

&#40;let &#91;raw-input-chan &#40;chan&#41;&#93;
  &#40;sub publication :raw-input raw-input-chan&#41;
  &#40;go-loop &#91;&#93;
    &#40;let &#91;{:keys &#91;form&#93;} &#40;&lt;! raw-input-chan&#41;
          &#91;errors valid-form&#93; &#40;v/validate-registration form&#41;&#93;
      &#40;if errors
        &#40;&gt;! pub-chan {:msg-type :response
                      :response &#40;-&gt; &#40;redirect &quot;/daftar&quot;&#41;
                                    &#40;flash {:errors errors :data form}&#41;&#41;}&#41;
        &#40;&gt;! pub-chan {:msg-type :valid-form :form valid-form}&#41;&#41;
      &#40;recur&#41;&#41;&#41;&#41;

&#40;let &#91;valid-form-chan &#40;chan&#41;&#93;
  &#40;sub publication :valid-form valid-form-chan&#41;
  &#40;async/thread
    &#40;loop &#91;&#93;
      &#40;let &#91;{:keys &#91;form&#93;} &#40;&lt;!! valid-form-chan&#41;
            existing-username &#40;users/find-user-by-username db-spec form&#41;&#93;
        &#40;&gt;!! pub-chan
             {:msg-type :existing-username :existing-username existing-username}&#41;
        &#40;recur&#41;&#41;&#41;&#41;&#41;

&#40;let &#91;valid-form-chan &#40;chan&#41;&#93;
  &#40;sub publication :valid-form valid-form-chan&#41;
  &#40;async/thread
    &#40;loop &#91;&#93;
      &#40;let &#91;{:keys &#91;form&#93;} &#40;&lt;!! valid-form-chan&#41;
            existing-email &#40;users/find-user-by-email db-spec form&#41;&#93;
        &#40;&gt;!! pub-chan {:msg-type :existing-email :existing-email existing-email}&#41;
        &#40;recur&#41;&#41;&#41;&#41;&#41;

&#40;let &#91;existing-username-chan &#40;chan&#41;
      existing-email-chan &#40;chan&#41;&#93;
  &#40;sub publication :existing-username existing-username-chan&#41;
  &#40;sub publication :existing-email existing-email-chan&#41;
  &#40;go-loop &#91;&#93;
    &#40;let &#91;{:keys &#91;existing-username&#93;} &#40;&lt;! existing-username-chan&#41;
          {:keys &#91;existing-email&#93;} &#40;&lt;! existing-email-chan&#41;
          user-existed &#40;boolean &#40;or existing-username existing-email&#41;&#41;&#93;
      &#40;&gt;! pub-chan {:msg-type :whether-user-existed :user-existed user-existed}&#41;
      &#40;recur&#41;&#41;&#41;&#41;

&#40;let &#91;whether-user-existed-chan &#40;chan&#41;
      valid-form-chan &#40;chan&#41;&#93;
  &#40;sub publication :whether-user-existed whether-user-existed-chan&#41;
  &#40;sub publication :valid-form valid-form-chan&#41;
  &#40;go-loop &#91;&#93;
    &#40;let &#91;{:keys &#91;user-existed&#93;} &#40;&lt;! whether-user-existed-chan&#41;
          {:keys &#91;form&#93;} &#40;&lt;! valid-form-chan&#41;&#93;
      &#40;if user-existed
        &#40;&gt;! pub-chan {:msg-type :response
                      :response &#40;-&gt; &#40;redirect &quot;/daftar&quot;&#41;
                                    &#40;flash {:message user-existed-msg}&#41;&#41;}&#41;
        &#40;&gt;! pub-chan {:msg-type :new-user :user form}&#41;&#41;
      &#40;recur&#41;&#41;&#41;&#41;

&#40;let &#91;new-user-chan &#40;chan&#41;&#93;
  &#40;sub publication :new-user new-user-chan&#41;
  &#40;async/thread
    &#40;loop &#91;&#93;
      &#40;let &#91;{:keys &#91;password&#93;} &#40;:user &#40;&lt;!! new-user-chan&#41;&#41;
            hashed-password &#40;hashers/derive password&#41;&#93;
        &#40;&gt;!! pub-chan {:msg-type :hashed-password :password hashed-password}&#41;
        &#40;recur&#41;&#41;&#41;&#41;&#41;

&#40;let &#91;new-user-chan &#40;chan&#41;&#93;
  &#40;sub publication :new-user new-user-chan&#41;
  &#40;go-loop &#91;&#93;
    &#40;&lt;! new-user-chan&#41;
    &#40;let &#91;token &#40;codecs/bytes-&gt;hex &#40;nonce/random-bytes 16&#41;&#41;&#93;
      &#40;&gt;! pub-chan {:msg-type :email-verification-token :token token}&#41;&#41;
    &#40;recur&#41;&#41;&#41;

&#40;let &#91;hashed-password-chan &#40;chan&#41;
      email-verification-token-chan &#40;chan&#41;
      new-user-chan &#40;chan&#41;&#93;
  &#40;sub publication :hashed-password hashed-password-chan&#41;
  &#40;sub publication :email-verification-token email-verification-token-chan&#41;
  &#40;sub publication :new-user new-user-chan&#41;
  &#40;go-loop &#91;&#93;
    &#40;let &#91;{:keys &#91;user&#93;} &#40;&lt;! new-user-chan&#41;
          {:keys &#91;password&#93;} &#40;&lt;! hashed-password-chan&#41;
          {:keys &#91;token&#93;} &#40;&lt;! email-verification-token-chan&#41;
          prepared-user &#40;assoc user :password password :token token&#41;&#93;
      &#40;&gt;! pub-chan {:msg-type :prepared-user :user prepared-user}&#41;
      &#40;recur&#41;&#41;&#41;&#41;

&#40;let &#91;prepared-user-chan &#40;chan&#41;&#93;
  &#40;sub publication :prepared-user prepared-user-chan&#41;
  &#40;async/thread
    &#40;loop &#91;&#93;
      &#40;let &#91;{:keys &#91;user&#93;} &#40;&lt;!! prepared-user-chan&#41;
            row-count &#40;users/register-user db-spec user&#41;&#93;
        &#40;if &#40;zero? row-count&#41;
          &#40;&gt;!! pub-chan {:msg-type :response
                         :response &#40;-&gt; &#40;redirect &quot;/daftar&quot;&#41;
                                       &#40;flash {:message failed-msg}&#41;&#41;}&#41;
          &#40;&gt;!! pub-chan {:msg-type :persisted-user :user user}&#41;&#41;
        &#40;recur&#41;&#41;&#41;&#41;&#41;

&#40;let &#91;persisted-user-chan &#40;chan&#41;&#93;
  &#40;sub publication :persisted-user persisted-user-chan&#41;
  &#40;async/thread
    &#40;loop &#91;&#93;
      &#40;let &#91;{:keys &#91;user&#93;} &#40;&lt;!! persisted-user-chan&#41;&#93;
        &#40;mailer/send-email-verification user&#41;
        &#40;recur&#41;&#41;&#41;&#41;&#41;

&#40;let &#91;persisted-user-chan &#40;chan&#41;&#93;
  &#40;sub publication :persisted-user persisted-user-chan&#41;
  &#40;go-loop &#91;&#93;
    &#40;&lt;! persisted-user-chan&#41;
    &#40;&gt;! pub-chan {:msg-type :response
                  :response &#40;-&gt; &#40;redirect &quot;/login&quot;&#41;
                                &#40;flash success-msg&#41;&#41;}&#41;
    &#40;recur&#41;&#41;&#41;

&#40;defn register &#91;{:keys &#91;params&#93;} respond &#95;&#93;
  &#40;let &#91;form &#40;select-keys params &#91;:username :email :password&#93;&#41;&#93;
    &#40;go &#40;let &#91;&#91;res &#95;&#93; &#40;alts! &#91;response-chan &#40;timeout 10000&#41;&#93;&#41;&#93;
          &#40;respond &#40;:response res&#41;&#41;&#41;&#41;
    &#40;put! pub-chan {:msg-type :raw-input :form form}&#41;&#41;&#41;

</code></pre><p>Akhirnya code tersebut jadi lebih kurang sama sahaja seperti penggunaan library RxJava atau pub/sub yang lain.</p><p>Satu trick yang saya suka buat, saya letakkan transducer untuk log data yang lalu ikut channel publisher. Dengan mudah dapat log semua event hanya dengan menukar satu line.</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/blog/tags/clojure/">clojure</a>
    
    <a href="/blog/tags/concurrency/">concurrency</a>
    
    <a href="/blog/tags/lisp/">lisp</a>
    
</div>


    

    <div id="prev-next">
        
        
        <a class="right" href="/blog/posts/2018-05-21-refactor-core-async-menggunakan-transducer/">Refactor code core.async menggunakan Transducer &raquo;</a>
        
    </div>
</div>

            </div>
        </div>

        <div class="col-md-3">
            <div id="sidebar">
                
                
                <div id="recent">
                    <h3>Recent Posts</h3>
                    <ul>
                        
                        <li><a href="/blog/posts/2018-05-23-pembetulan-post-lepas-mengenai-core-async/">Pembetulan post lepas mengenai core.async</a></li>
                        
                        <li><a href="/blog/posts/2018-05-21-refactor-core-async-menggunakan-transducer/">Refactor code core.async menggunakan Transducer</a></li>
                        
                        <li><a href="/blog/posts/2017-05-06-greenspun-tenth-rule/">Greenspun&#39;s Tenth Rule</a></li>
                        
                    </ul>
                </div>
                
                
                <div id="tags">
                    <h3>Tags</h3>
                    <ul>
                        
                        <li><a href="/blog/tags/clojure/">clojure</a></li>
                        
                        <li><a href="/blog/tags/concurrency/">concurrency</a></li>
                        
                        <li><a href="/blog/tags/lisp/">lisp</a></li>
                        
                        <li><a href="/blog/tags/java/">java</a></li>
                        
                        <li><a href="/blog/tags/completablefuture/">completablefuture</a></li>
                        
                        <li><a href="/blog/tags/web-scraping/">web-scraping</a></li>
                        
                        <li><a href="/blog/tags/c++/">c++</a></li>
                        
                        <li><a href="/blog/tags/go/">go</a></li>
                        
                        <li><a href="/blog/tags/javascript/">javascript</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2018 Burhanuddin Baharuddin
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="js/highlight.pack.js" type="text/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
